(Concerning to original README.md, please refer to README_ORIG.md.)
# Implementation of *Fast* R-CNN on Another Dataset: [Right Whale Recognition](https://www.kaggle.com/c/noaa-right-whale-recognition)

## Preparing Dataset
Following the steps list on [Train Fast-RCNN on Another Dataset](https://github.com/zeyuanxy/fast-rcnn/tree/master/help/train) and [How to train fast rcnn on imagenet](http://sunshineatnoon.github.io/Train-fast-rcnn-model-on-imagenet-without-matlab/), prepare your own dataset.

Below is my dataset directory:
```
kaggle
|-- data
    |-- train.mat
    |-- Annotations
         |-- *.xml (Annotation files)
    |-- Images
         |-- *.JPEG (Image files)
    |-- ImageSets
         |-- train.txt
```
- train.mat: This is the selective search proposals file, which generated by either `selective_search.m` in `$FRCNN_ROOT/selective_search`(if you do not have that directory, you could find it [here](https://github.com/EdisonResearch/fast-rcnn/tree/master/selective_search)) or [dlib's slective search](http://dlib.net/) recommended for those don't have MATLAB installed.
- Annotations: This folder contains all annotation files of the images, in my implementation, it is in xml format. There's only one object (right whale's face) and one class I should to describe. Below is the example:
```
<? w_819.xml ?>
<annotation>
  <folder>kaggle</folder>
    <filename>
      <item>w_819.jpg</item>
    </filename>
    <object>
      <name>whale</name>
      <bndbox>
        <xmin>1277</xmin>
        <ymin>568</ymin>
        <xmax>1554</xmax>
        <ymax>961</ymax>
      </bndbox>
    </object>
</annotation>
```
- Images: This folder contains all images
- ImageSets: This folder originally only contains one file--trian.txt, which contains all the names of the images. It looks like this:
```
w_8762
w_3935
w_1087
...
```
while I add another file--test.txt having the same format as train.txt to store the file names of the test data.

## Construct IMDB File
We have to create a file kaggle.py in the directory `$FRCNN_ROOT/lib/datasets`, where `$FRCNN_ROOT` means your path to fast-rcnn directory, e.g. `/home/coldmanck/fast-rcnn`. This file defines some functions which tell fast rcnn how to read ground truth boxes and how to find images on disk. Following the example file [inria.py](https://github.com/EdisonResearch/fast-rcnn/blob/master/lib/datasets/inria.py) created by [zeyuanxy's instruction](https://github.com/zeyuanxy/fast-rcnn/tree/master/help/train) , I mainly modified some functions below. You may want to read along with my file [kaggle.py](https://github.com/coldmanck/fast-rcnn/blob/master/lib/datasets/kaggle.py).

**In function `__init__(self, image_set, devkit_path)`**

Modify the classes name and picture format to fit the dataset.
```
self._classes = ('__background__', 'whale')
self._image_ext = '.jpg'
```

**In function `image_path_from_index(self, index)`**

Revise the code to train on only **one** class. Note that if you would like to detect multiple classes, do not modify anything here.
```
image_path = os.path.join(self._data_path,'Images',index+self._image_ext)
assert os.path.exists(image_path), 'Path does not exist: {}'.format(image_path)
return image_path
```

**In function `_load_imagenet_annotation`**

This is th function for parsing annotations which should be figured out carefully. Here, I follow the instruction of [sunshinearnoon](http://sunshineatnoon.github.io/Train-fast-rcnn-model-on-imagenet-without-matlab/), define a new inner-function to get the tags from xml files.
```
def get_data_from_tag(node,tag):
  return node.getElementsByTagName(tag)[0].childNodes[0].data

with open(filename) as f:
  data = minidom.parseString(f.read())
  
objs = data.getElementsByTagName('object')
num_objs = len(objs)
```
Also, in the for loop of process of loading object bounding boxes into a data frame, there're something should be modified:
```
x1 = float(get_data_from_tag(obj, 'xmin')) - 1
y1 = float(get_data_from_tag(obj, 'ymin')) - 1
x2 = float(get_data_from_tag(obj, 'xmax')) - 1
y2 = float(get_data_from_tag(obj, 'ymax')) - 1
```
This is because the data format of Right Whale dataset, which coordinates start from zero, is different from the original format. Therefore I need to minus one.


## Reference
1. [Train Fast-RCNN on Another Dataset](https://github.com/zeyuanxy/fast-rcnn/tree/master/help/train)
2. [How to train fast rcnn on imagenet](http://sunshineatnoon.github.io/Train-fast-rcnn-model-on-imagenet-without-matlab/)
3. [Selective Search Configuration](https://github.com/rbgirshick/fast-rcnn/issues/26)
4. [Fast rcnn 訓練自己的數據庫問題小結](http://blog.csdn.net/hao529good/article/details/46544163)
